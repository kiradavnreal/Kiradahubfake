local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Terrain = workspace:WaitForChild("Terrain")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid", 5)
local rootPart = character:WaitForChild("HumanoidRootPart", 5)

if not humanoid or not rootPart then
    warn("Không tìm thấy Humanoid hoặc HumanoidRootPart!")
    return
end

-- Kiểm tra anti-cheat cơ bản (lấy ý từ Redz Hub)
local hasAntiCheat = ReplicatedStorage:FindFirstChild("AntiCheat") or workspace:FindFirstChild("AntiExploit")
if hasAntiCheat then
    warn("Game có anti-cheat mạnh! Sử dụng safe mode.")
end

-- Tạo GUI Menu (ẩn tốt hơn với Enabled)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KiradaHalloween"
ScreenGui.Parent = player.PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Enabled = true  -- Bật/tắt để ẩn hoàn toàn

-- Âm thanh Halloween (giảm volume để thầm lặng)
local halloweenSound = Instance.new("Sound")
halloweenSound.SoundId = "rbxassetid://1839246711"
halloweenSound.Looped = true
halloweenSound.Volume = 0.3  -- Giảm để ít bị chú ý
halloweenSound.Parent = workspace
halloweenSound:Play()

-- Nút Toggle (hỗ trợ drag)
local toggleButton = Instance.new("ImageButton")
toggleButton.Size = UDim2.new(0, 60, 0, 60)
toggleButton.Position = UDim2.new(0, 10, 0, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(139, 0, 0)
toggleButton.Image = "rbxassetid://89326205091486"
toggleButton.Parent = ScreenGui

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 15)
toggleCorner.Parent = toggleButton

-- Frame chính
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 400, 0, 300)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -150)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BackgroundTransparency = 0.5
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
mainFrame.Parent = ScreenGui

-- ... (giữ nguyên các phần tạo UI như createTextBox, createButton, titleLabel, các button/input)

-- Biến trạng thái (thêm safeMode)
local safeMode = true  -- Bật safe mode mặc định như Banana Hub
local velocityInstance = nil  -- Cho speed/jump bypass

-- Hàm notify (giảm sử dụng để thầm lặng)
local function notify(message)
    if not safeMode then  -- Chỉ notify nếu không safe
        game.StarterGui:SetCore("SendNotification", {Title = "Kirada Halloween", Text = message, Duration = 3})
    end
end

-- Toggle Menu (thêm ẩn Enabled)
toggleButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
    ScreenGui.Enabled = mainFrame.Visible  -- Ẩn toàn bộ GUI khi không dùng
    -- ... (giữ nguyên tween và sound)
end)

-- Xử lý tốc độ (sử dụng BodyVelocity thay vì WalkSpeed, như HoHo)
speedButton.MouseButton1Click:Connect(function()
    local speed = tonumber(speedInput.Text)
    if speed then
        customWalkSpeed = math.clamp(speed, 0, 1000)
        if velocityInstance then velocityInstance:Destroy() end
        velocityInstance = Instance.new("BodyVelocity")
        velocityInstance.MaxForce = Vector3.new(math.huge, 0, math.huge)
        velocityInstance.Parent = rootPart
        RunService.Heartbeat:Connect(function()
            if rootPart then
                velocityInstance.Velocity = rootPart.CFrame.LookVector * customWalkSpeed
            end
        end)
        notify("Đã đặt tốc độ bypass: " .. customWalkSpeed)
    end
end)

-- Xử lý nhảy (sử dụng LinearVelocity cho jump bypass)
jumpButton.MouseButton1Click:Connect(function()
    local jumpPower = tonumber(jumpInput.Text)
    if jumpPower then
        customJumpPower = math.clamp(jumpPower, 0, 500)
        humanoid.UseJumpPower = true
        local jumpVelocity = Instance.new("LinearVelocity")
        jumpVelocity.MaxForce = math.huge
        jumpVelocity.Parent = rootPart
        humanoid.Jumping:Connect(function()
            jumpVelocity.VectorVelocity = Vector3.new(0, customJumpPower, 0)
            if safeMode then task.wait(math.random(0.1, 0.3)) end  -- Delay ngẫu nhiên
        end)
        notify("Đã đặt nhảy bypass: " .. customJumpPower)
    end
end)

-- Anti-AFK (chuyển động ngẫu nhiên thay vì click, như Banana)
antiAfkToggle.MouseButton1Click:Connect(function()
    isAntiAfk = not isAntiAfk
    antiAfkToggle.Text = "Anti-AFK: " .. (isAntiAfk and "BẬT" or "TẮT")
    
    if isAntiAfk then
        antiAfkConnection = RunService.Heartbeat:Connect(function()
            if tick() % 300 < 0.1 then
                pcall(function()
                    rootPart.CFrame = rootPart.CFrame + Vector3.new(math.random(-1,1), 0, math.random(-1,1))  -- Chuyển động ngẫu nhiên
                    if safeMode then task.wait(math.random(1, 3)) end  -- Delay tự nhiên
                end)
            end
        end)
        notify("Đã bật Anti-AFK bypass")
    else
        -- ... (giữ nguyên disconnect)
    end
end)

-- Fishing với hookmetamethod (spoof FireServer, lấy ý từ Redz/HoHo)
bypassFishButton.MouseButton1Click:Connect(function()
    if not isFishing then return end
    isBypassFishing = not isBypassFishing
    -- ... (giữ nguyên text update)
    
    if isBypassFishing then
        local oldNamecall = nil
        oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
            if getnamecallmethod() == "FireServer" and self.Name:lower():find("fish") then
                local args = {...}
                args[1] = "Caught"  -- Spoof argument
                if safeMode then task.wait(math.random(0.5, 2)) end  -- Delay để tránh detect
                return oldNamecall(self, unpack(args))
            end
            return oldNamecall(self, ...)
        end)
        notify("Đã bật Bypass Cá với hook")
    else
        -- ... (giữ nguyên disconnect)
    end
end)

-- ... (Giữ nguyên các phần còn lại như Water Walk với kiểm tra raycast tự nhiên hơn, Fly external, CharacterAdded)

-- Thêm toggle cho Safe Mode
local safeModeToggle = createButton("SafeModeToggle", UDim2.new(0, 270, 0, 210), "Safe Mode: BẬT", scrollingFrame)
safeModeToggle.MouseButton1Click:Connect(function()
    safeMode = not safeMode
    safeModeToggle.Text = "Safe Mode: " .. (safeMode and "BẬT" or "TẮT")
    notify("Safe Mode: " .. (safeMode and "Bật (chậm hơn nhưng an toàn)" or "Tắt (nhanh hơn nhưng rủi ro)"))
end)
